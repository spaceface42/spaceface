var ye=Object.defineProperty;var h=(a,e)=>()=>(a&&(e=a(a=0)),e);var A=(a,e)=>{for(var t in e)ye(a,t,{get:e[t],enumerable:!0})};var V,o,p=h(()=>{"use strict";V=class{listeners=new Map;anyListeners=[];onceWrappers=new WeakMap;emittingError=!1;debugMode=!1;setDebugMode(e){this.debugMode=e,this.debugMode&&console.debug("[EventBus] Debug mode enabled")}on(e,t,i=0){let r=this.listeners.get(e)??[],n={fn:t,priority:i},s=r.length;for(;s>0&&r[s-1].priority<i;)s--;return r.splice(s,0,n),this.listeners.set(e,r),this.debugMode&&console.debug(`[EventBus] Listener added for event: ${e}`,{priority:i}),()=>this.off(e,t)}once(e,t,i=0){let r=n=>{this.off(e,r),t(n)};return this.onceWrappers.set(t,r),this.on(e,r,i),()=>this.off(e,t)}off(e,t){let i=this.listeners.get(e);if(!i)return;let r=this.onceWrappers.get(t)??t;this.listeners.set(e,i.filter(n=>n.fn!==r)),this.debugMode&&console.debug(`[EventBus] Listener removed for event: ${e}`)}hasListeners(e){return e==="any"?this.anyListeners.length>0:(this.listeners.get(e)?.length??0)>0}onAny(e,t=0){let i={fn:e,priority:t},r=this.anyListeners.length;for(;r>0&&this.anyListeners[r-1].priority<t;)r--;return this.anyListeners.splice(r,0,i),this.debugMode&&console.debug("[EventBus] Listener added for any event",{priority:t}),()=>this.offAny(e)}offAny(e){this.anyListeners=this.anyListeners.filter(t=>t.fn!==e),this.debugMode&&console.debug("[EventBus] Listener removed for any event")}emit(e,t){if(!e){this._handleError("Event name is undefined or empty",new Error);return}this.debugMode&&console.debug(`[EventBus] Emitting event: ${e}`,t);let i=[...this.listeners.get(e)??[]];for(let n of i)try{n.fn(t)}catch(s){this._handleError(`Error in listener for "${e}"`,s)}let r=[...this.anyListeners];for(let n of r)try{n.fn(e,t)}catch(s){this._handleError(`Error in any-listener for "${e}"`,s)}}async emitAsync(e,t){if(!e)return this._handleError("Event name is undefined or empty",new Error),[];let i=[],r=[...this.listeners.get(e)??[]];for(let s of r)try{i.push(await s.fn(t))}catch(d){this._handleError(`Async error in listener for "${e}"`,d)}let n=[...this.anyListeners];for(let s of n)try{i.push(await s.fn(e,t))}catch(d){this._handleError(`Async error in any-listener for "${e}"`,d)}return i}removeAllListeners(e){e?e==="any"?this.anyListeners=[]:this.listeners.delete(e):(this.listeners.clear(),this.anyListeners=[]),this.debugMode&&console.debug(`[EventBus] All listeners removed for event: ${e??"all"}`)}listenerCount(e){return e==="any"?this.anyListeners.length:this.listeners.get(e)?.length??0}eventNames(){return Array.from(this.listeners.keys()).filter(e=>(this.listeners.get(e)?.length??0)>0)}getListeners(e){return e==="any"?this.anyListeners.map(t=>t.fn):(this.listeners.get(e)??[]).map(t=>t.fn)}_handleError(e,t){this.emittingError||(this.emittingError=!0,console.error(`[EventBus] ${e}`,t),this.emittingError=!1)}},o=new V});var M,j=h(()=>{"use strict";p();M=class{target;debug;destroyed=!1;domListeners=new Set;loggedMessages=new Set;constructor(e,t=!1){if(!e||typeof e.addEventListener!="function"||typeof e.removeEventListener!="function")throw new Error(`${this.constructor.name}: target must be a valid EventTarget.`);this.target=e,this.debug=t}log(e,t,i){if(typeof e=="string"&&["debug","info","warn","error"].includes(e)&&typeof t=="string"){let l=e,c=t,u=i;if(!this.debug&&l==="debug")return;try{let m={scope:this.constructor.name,level:l,message:c,data:u,time:Date.now()};o.emit("log",m)}catch{}if(this.debug){let m={debug:"debug",info:"info",warn:"warn",error:"error"}[l]??"log";console[m](`[${this.constructor.name}] [${l.toUpperCase()}]`,c,u)}return}let n=e,s=t;if(!this.debug)return;let d;try{d=`${n}-${JSON.stringify(s)}`}catch{d=`${n}-[unserializable]`}if(!this.loggedMessages.has(d)){this.loggedMessages.add(d);try{let l=s&&typeof s=="object"?JSON.parse(JSON.stringify(s)):s,c={scope:this.constructor.name,level:"debug",message:n,data:l,time:Date.now()};o.emit("log:debug",c)}catch(l){console.warn("Failed to log debug event",{message:n,payload:s,error:l})}}console.debug?.(`[${this.constructor.name}] [DEBUG]`,n,s)}checkDestroyed(){if(this.destroyed)throw new Error(`${this.constructor.name} has been destroyed.`)}destroy(){if(!this.destroyed){this.log("info","Destroying watcher");try{this.removeAllDomListeners(),this.removeEventListeners()}catch(e){this.log("error","Error while destroying watcher",e)}finally{this.destroyed=!0}}}addDomListener(e,t,i){this.destroyed||(this.target.addEventListener(e,t,i),this.domListeners.add({type:e,handler:t,options:i}),this.debug&&this.log("debug","Added DOM listener",{type:e,handler:t,options:i}))}removeAllDomListeners(){for(let{type:e,handler:t,options:i}of this.domListeners)try{this.target.removeEventListener(e,t,i),this.debug&&this.log("debug","Removed DOM listener",{type:e,handler:t})}catch(r){this.log("warn","Failed to remove DOM listener",{type:e,handler:t,error:r})}this.domListeners.clear()}}});function re(){let a=null;return{get id(){return a},set(e,t){a!==null&&clearTimeout(a),a=window.setTimeout(()=>{a=null,e()},t)},cancel(){a!==null&&(clearTimeout(a),a=null)}}}function b(a,e=300,t=!1){if(typeof a!="function")throw new TypeError("Expected a function for debounce");if(typeof e!="number"||e<0)throw new TypeError("Expected a non-negative number for delay");let i=re();function r(...n){let s=t&&i.id===null;i.set(()=>{t||a.apply(this,n)},e),s&&a.apply(this,n)}return r.cancel=()=>i.cancel(),r}function O(a,e=100,t={}){if(typeof a!="function")throw new TypeError("Expected a function for throttle");if(typeof e!="number"||e<0)throw new TypeError("Expected a non-negative number for delay");let{leading:i=!0,trailing:r=!0}=t,n=0,s=null,d=null,l=re();function c(){n=i?Date.now():0,a.apply(d,s),s=d=null}function u(...m){let P=Date.now();n===0&&!i&&(n=P),s=m,d=this;let v=e-(P-n);v<=0||v>e?(l.cancel(),c()):l.id===null&&r&&l.set(()=>{r&&s&&c()},v)}return u.cancel=()=>{l.cancel(),n=0,s=d=null},u}var S=h(()=>{"use strict"});var y,q=h(()=>{"use strict";j();p();S();y=class a extends M{static _instance=null;inactivityDelay;lastActiveAt;timer;userIsInactive=!1;throttledReset;constructor(e,t){super(e,t.debug??!1),this.inactivityDelay=t.inactivityDelay,this.lastActiveAt=Date.now(),this.throttledReset=O(()=>this.resetTimer(),200),this.log(`Initialized with inactivityDelay=${this.inactivityDelay}ms`),this.addEventListeners()}static getInstance(e){return this._instance||(this._instance=new a(e.target??document,e)),this._instance}addEventListeners(){this.addDomListener("mousemove",this.throttledReset),this.addDomListener("keydown",this.throttledReset),this.addDomListener("scroll",this.throttledReset),this.addDomListener("visibilitychange",this.throttledReset),this.resetTimer()}removeEventListeners(){this.removeAllDomListeners(),this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){let e=Date.now();this.lastActiveAt=e,this.userIsInactive&&(this.userIsInactive=!1,o.emit("user:active",{lastActiveAt:this.lastActiveAt,inactivityDelay:this.inactivityDelay,visible:document.visibilityState==="visible"}),this.log("User is active")),this.timer&&clearTimeout(this.timer),this.timer=window.setTimeout(()=>this.setInactive(),this.inactivityDelay)}setInactive(){this.userIsInactive=!0;let e=Date.now();o.emit("user:inactive",{lastActiveAt:this.lastActiveAt,inactiveAt:e,inactivityDelay:this.inactivityDelay,visible:document.visibilityState==="visible"}),this.log("User is inactive")}}});var R,ne=h(()=>{"use strict";p();R=class{scope;devMode;fallbackLogs=[];constructor(e,t=!0){this.scope=e,this.devMode=t}shouldLog(e){let t=["debug","info","event","warn","error"],i=t.indexOf(this.devMode?"debug":"warn");return t.indexOf(e)>=i}log(e,t,i){if(!this.shouldLog(e))return;let r={level:e,scope:this.scope,message:t,data:i,time:Date.now()};try{o.emit("log",r)}catch(n){this.fallbackLogs.push(r),this.devMode&&console.error("[EventLogger][ERROR] Failed to emit log event",{entry:r,error:n})}this.devMode&&(console.debug("[EventLogger][DEBUG] Logging to console",{level:e,message:t,data:i}),this.consoleOutput(e,t,i))}consoleOutput(e,t,i){let r;switch(e){case"warn":r="warn";break;case"error":r="error";break;default:r="log"}let n=`[${this.scope}][${e.toUpperCase()}]`;i!==void 0?console[r](n,t,i):console[r](n,t)}getFallbackLogs(){return this.fallbackLogs}debug(e,t){this.log("debug",e,t)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}event(e,t){this.log("event",e,t)}error(e,t){this.log("error",e,t)}}});var f,_e,W=h(()=>{"use strict";p();ne();f=class a{IBusBindings=[];domBindings=[];debugMode;logger;constructor(e=!1){this.debugMode=e,this.logger=new R("eventbinder")}debug(e,t){if(this.debugMode)try{let i={method:e,details:t};this.logger.debug(e,i)}catch(i){console.error(`Debugging failed in method: ${e}`,i)}}attachTo(e){if(e.aborted)return this.unbindAll(),()=>{};let t=()=>this.unbindAll();return e.addEventListener("abort",t,{once:!0}),()=>{try{e.removeEventListener("abort",t)}catch(i){console.warn("Failed to remove abort listener",i)}}}setDebugMode(e){this.debugMode=e,this.logger.info(`Debug mode ${e?"enabled":"disabled"}`)}bindBus(e,t){if(this.IBusBindings.find(i=>i.event===e&&i.handler===t)){this.debug("bus:bind:duplicate",{event:e,handler:t});return}try{let i=o.on(e,t);this.IBusBindings.push({event:e,handler:t,unsubscribe:i}),this.debug("bus:bind",{event:e,handler:t})}catch(i){this.logger.error(`Failed to bind bus event "${e}": ${i instanceof Error?i.message:String(i)}`)}}bindDOM(e,t,i,r=!1){if(!e||typeof e.addEventListener!="function"||typeof e.removeEventListener!="function"){this.logger.warn(`Invalid DOM target for bindDOM: ${String(e)}`);return}let n=new AbortController,s=typeof r=="boolean"?{capture:r,signal:n.signal}:{...r,signal:n.signal},d=(l,c)=>!!l==!!c&&(l?.capture??!1)===(c?.capture??!1)&&(l?.passive??!1)===(c?.passive??!1)&&(l?.once??!1)===(c?.once??!1);if(this.domBindings.find(l=>l.target===e&&l.event===t&&l.handler===i&&d(l.options,s))){this.debug("dom:bind:duplicate",{event:t,handler:i,target:e,options:s});return}try{e.addEventListener(t,i,s),this.domBindings.push({target:e,event:t,handler:i,options:s,controller:n}),this.debug("dom:bind",{event:t,handler:i,target:e,options:s})}catch(l){this.logger.error(`Failed to bind DOM event "${t}": ${l instanceof Error?l.message:String(l)}`)}}unbindAll(){this.debug("unbindAll",{bus:this.IBusBindings.length,dom:this.domBindings.length});for(let e of this.IBusBindings)try{e.unsubscribe(),this.debug("bus:unbind",{event:e.event})}catch(t){this.logger.error(`Failed to unbind bus "${e.event}": ${t instanceof Error?t.message:String(t)}`)}for(let e of this.domBindings)try{e.controller.abort(),this.debug("dom:unbind",{event:e.event,target:e.target})}catch(t){this.logger.error(`Failed to unbind DOM "${e.event}": ${t instanceof Error?t.message:String(t)}`)}this.IBusBindings=[],this.domBindings=[]}unbindBus(e,t){let i=this.IBusBindings.findIndex(r=>r.event===e&&r.handler===t);if(i===-1)return!1;try{return this.IBusBindings[i].unsubscribe(),this.IBusBindings.splice(i,1),this.debug("bus:unbind:single",{event:e,handler:t}),!0}catch(r){return this.logger.error(`Failed to unbind bus "${e}": ${r instanceof Error?r.message:String(r)}`),!1}}unbindDOM(e,t,i){let r=this.domBindings.findIndex(n=>n.target===e&&n.event===t&&n.handler===i);if(r===-1)return!1;try{return this.domBindings[r].controller.abort(),this.domBindings.splice(r,1),this.debug("dom:unbind:single",{event:t,target:e}),!0}catch(n){return this.logger.error(`Failed to unbind DOM "${t}": ${n instanceof Error?n.message:String(n)}`),!1}}getStats(){return{busEvents:this.IBusBindings.length,domEvents:this.domBindings.length,totalEvents:this.IBusBindings.length+this.domBindings.length}}hasBindings(){return this.IBusBindings.length>0||this.domBindings.length>0}getBindingDetails(){return{bus:this.IBusBindings.map(e=>e.event),dom:this.domBindings.map(e=>`${e.event}@${e.target.constructor.name}`)}}static withAutoUnbind(e,t=!1){let i=new a(t);try{let r=e(i);return r instanceof Promise?r.finally(()=>i.unbindAll()):(i.unbindAll(),r)}catch(r){throw i.unbindAll(),r}}},_e=new f});var se={};A(se,{PartialLoader:()=>E,VERSION:()=>we});var we,E,B=h(()=>{"use strict";S();p();we="nextworld-1.3.0",E=class{cache=new Map;loadingPromises=new Map;loadedPartials=new Map;options;constructor(e={}){this.options={debug:!1,baseUrl:"/",cacheEnabled:!0,timeout:1e4,retryAttempts:3,...e}}logDebug(e,t){if(this.options.debug){let i=`${e}-${JSON.stringify(t)}`;if(!this.loadedPartials.has(i)){this.loadedPartials.set(i,!0);let r={scope:"PartialLoader",level:"debug",message:e,data:t,time:Date.now()};o.emit("log:debug",r),o.emit("log",r)}}}async load(e){let t=Array.isArray(e)?e:[e],i=[];for(let r of t)try{r instanceof HTMLLinkElement?i.push(await this.loadLink(r)):i.push(await this.loadInfo(r))}catch(n){let s=r instanceof HTMLLinkElement?r.getAttribute("src")||"":r.url;this.logDebug("Failed to load partial",{url:s,error:n}),i.push({success:!1,url:s,cached:!1})}return o.emit("partials:allLoaded",{url:"",cached:!1}),this.logDebug("All partials loaded",{count:i.length}),i}loadLink(e){let t=e.getAttribute("src");if(!t)throw new Error("Partial link missing src");return this.loadUrl(this.resolveUrl(t),e)}loadInfo(e){return this.loadUrl(this.resolveUrl(e.url),e.container,e.id)}async loadUrl(e,t,i){try{if(this.options.cacheEnabled&&this.cache.has(e))return this.insertHTML(t,this.cache.get(e)),this.loadedPartials.set(i||e,!0),o.emit("partial:loaded",{url:e,html:this.cache.get(e),cached:!0}),this.logDebug("Partial loaded from cache",{url:e,id:i}),{success:!0,url:e,cached:!0};let r=this.loadingPromises.get(e);r||(r=this.fetchWithRetry(e),this.loadingPromises.set(e,r));let n=await r;return this.options.cacheEnabled&&this.cache.set(e,n),this.insertHTML(t,n),this.loadedPartials.set(i||e,!0),o.emit("partial:loaded",{url:e,html:n,cached:!1}),this.logDebug("Partial loaded",{url:e,id:i}),{success:!0,url:e,cached:!1}}catch(r){throw this.showError(t,r),o.emit("partial:error",{url:e,error:r}),this.logDebug("Partial load failed",{url:e,id:i,error:r}),r}finally{this.loadingPromises.delete(e),o.emit("partial:load:complete",{url:e}),this.logDebug("Partial load complete",{url:e,id:i})}}async fetchWithRetry(e,t=1){let i=new AbortController,r=setTimeout(()=>i.abort(),this.options.timeout);try{let n=await fetch(e,{signal:i.signal,headers:{Accept:"text/html"}});if(!n.ok)throw new Error(`HTTP ${n.status}`);let s=(await n.text()).trim();if(!s)throw new Error("Empty response");return s}catch(n){if(t<this.options.retryAttempts)return this.logDebug("Retrying fetch",{url:e,attempt:t}),await this.delay(Math.min(2**t*100,5e3)),this.fetchWithRetry(e,t+1);throw n}finally{clearTimeout(r)}}async fetchPartial(e,t=1){let i=new AbortController,r=setTimeout(()=>i.abort(),this.options.timeout);try{let n=await fetch(e,{signal:i.signal,headers:{Accept:"text/html"}});if(!n.ok)throw new Error(`HTTP ${n.status}`);let s=(await n.text()).trim();if(!s)throw new Error("Empty response");return s}catch(n){if(t<this.options.retryAttempts)return this.logDebug("Retrying fetch",{url:e,attempt:t}),await this.delay(Math.min(2**t*100,5e3)),this.fetchPartial(e,t+1);throw n}finally{clearTimeout(r)}}insertHTML(e,t){let i=document.createElement("template");i.innerHTML=t,e instanceof HTMLLinkElement?e.replaceWith(...i.content.childNodes):e instanceof Element?(e.innerHTML="",e.append(...i.content.childNodes)):e.append(...i.content.childNodes),this.logDebug("Inserted HTML into container",{container:e})}showError(e,t){let i=document.createElement("div");i.className="partial-error",i.textContent="Partial load failed",this.options.debug&&(i.textContent+=`: ${t.message}`),e instanceof HTMLLinkElement?e.replaceWith(i):(e instanceof Element&&(e.innerHTML=""),e.appendChild(i)),o.emit("log:error",{scope:"PartialLoader",message:"Partial load failed",error:t,context:{url:e instanceof HTMLLinkElement?e.href:void 0,retryAttempts:this.options.retryAttempts}}),this.logDebug("Error displayed in container",{container:e,error:t})}isPartialLoaded(e){return this.loadedPartials.has(e)}resolveUrl(e){if(/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(e)||e.startsWith("//"))return this.logDebug("URL is already absolute",{src:e}),e;try{let t=this.options.baseUrl||window.location.origin+"/",i=new URL(e,t).toString(),r=i.startsWith(window.location.origin)?i.slice(window.location.origin.length)||"/":i;return this.logDebug("Resolved relative URL",{src:e,resolvedUrl:r}),r}catch(t){return this.logDebug("Failed to resolve URL",{src:e,error:t}),e}}delay(e){return this.logDebug("Delaying execution",{ms:e}),new Promise(t=>setTimeout(t,e))}async loadContainer(e=document){let t=e.querySelectorAll('link[rel="partial"][src]');return t.length?this.load(Array.from(t)):[]}watch(e=document.body){if(!window.MutationObserver)return;let t=new MutationObserver(b(()=>this.loadContainer(e),100));return t.observe(e,{childList:!0,subtree:!0}),this.logDebug("Watching container for partials",{container:e}),t}async fetchWithLoaderCache(e){if(this.options.cacheEnabled&&this.cache.has(e))return this.logDebug("Fetching from cache",{url:e}),this.cache.get(e);let t=await this.fetchPartial(e);return this.options.cacheEnabled&&this.cache.set(e,t),this.logDebug("Fetched and cached partial",{url:e}),t}}});var x,Y=h(()=>{"use strict";p();B();x=class{static loader;static getLoader(){return this.loader??(this.loader=new E)}static logDebug(e,t){let i={scope:"PartialFetcher",level:"debug",message:e,data:t,time:Date.now()};o.emit("log",i)}static async load(e,t,i={}){let r=i.loader??this.getLoader(),n=document.querySelector(t);if(!n)throw new Error(`Target ${t} not found`);try{this.logDebug("Fetching partial",{url:e,targetSelector:t}),await r.load([{url:e,container:n}]),o.emit("partial:loaded",{url:e,targetSelector:t,cached:!1}),this.logDebug("Partial loaded successfully",{url:e,targetSelector:t})}catch(s){throw o.emit("partial:error",{url:e,error:s}),this.logDebug("Partial load error",{url:e,error:s}),s}finally{o.emit("partial:load:complete",{url:e,targetSelector:t,error:!1})}}static async preload(e,t){let i=t??this.getLoader(),r=document.createElement("div");return Promise.all(e.map(async n=>{try{this.logDebug("Preloading partial",{url:n}),await i.load([{url:n,container:r}]),o.emit("partial:loaded",{url:n,cached:!0})}catch(s){o.emit("partial:error",{url:n,error:s}),this.logDebug("Preload error",{url:n,error:s})}finally{o.emit("partial:load:complete",{url:n,error:!1})}}))}static watch(e=document.body,t){let i=t??this.getLoader();return this.logDebug("Watching container for partials",{container:e}),i.watch?.(e)}}});var ae={};A(ae,{ServiceWorkerManager:()=>z,VERSION:()=>Ee});var Ee,z,G=h(()=>{"use strict";Ee="nextworld-1.0.0",z=class{swPath;options;customConfig;registration=null;isSupported;constructor(e="/sw.js",t={},i={}){this.swPath=e,this.options={scope:"/",updateViaCache:"none",...t},this.customConfig=i,this.isSupported="serviceWorker"in navigator}async register(){if(!this.isSupported)throw new Error("ServiceWorker not supported");try{return this.registration=await navigator.serviceWorker.register(this.swPath,this.options),this.setupEventListeners(),this.registration}catch(e){throw console.error("SW registration failed:",e),e}}configure(){this.customConfig.strategy&&this.setStrategy(this.customConfig.strategy)}async unregister(){if(!this.registration)return!1;try{return await this.registration.unregister()}catch(e){return console.error("SW unregistration failed:",e),!1}}async update(){if(!this.registration)return null;try{return await this.registration.update(),null}catch(e){return console.error("SW update failed:",e),null}}getStatus(){return this.registration?this.registration.installing?"installing":this.registration.waiting?"waiting":this.registration.active?"active":"unknown":"unregistered"}setupEventListeners(){this.registration&&(this.registration.addEventListener("updatefound",()=>{let e=this.registration?.installing;e&&e.addEventListener("statechange",()=>{e.state==="installed"&&navigator.serviceWorker.controller&&this.onUpdateAvailable?.(e)})}),navigator.serviceWorker.addEventListener("controllerchange",()=>{this.onControllerChange?.()}))}async postMessage(e,t){let i=navigator.serviceWorker.controller;if(!i)throw new Error("No active service worker");t?i.postMessage(e,{transfer:t}):i.postMessage(e)}waitForMessage(e=5e3){return new Promise((t,i)=>{let r=setTimeout(()=>i(new Error("Message timeout")),e),n=s=>{clearTimeout(r),navigator.serviceWorker.removeEventListener("message",n),t(s.data)};navigator.serviceWorker.addEventListener("message",n)})}async activateWaiting(){if(!this.registration?.waiting)return!1;try{return await this.postMessage({type:"SKIP_WAITING"}),!0}catch(e){return console.error("Failed to activate waiting SW:",e),!1}}setStrategy(e={}){if(!navigator.serviceWorker.controller){console.warn("No active SW to set strategy");return}this.postMessage({type:"SET_STRATEGY",payload:e})}}});var L,J=h(()=>{"use strict";L=class{container;includePicture;debug;cache=new WeakMap;destroyed=!1;constructor(e,t={}){if(!(e instanceof Element))throw new Error("AsyncImageLoader: container must be a DOM Element.");this.container=e,this.includePicture=t.includePicture??!1,this.debug=t.debug??!1}logDebug(e,t){this.debug&&console.debug(`[AsyncImageLoader] ${e}`,t)}ensureActive(e){if(this.destroyed||!this.container)throw new Error(`AsyncImageLoader: Instance destroyed. Method: ${e}`)}getImages(e="img"){if(this.ensureActive("getImages"),!e.trim())return[];let t=new Set;return this.container.querySelectorAll(e).forEach(i=>{if(i instanceof HTMLImageElement){if(!this.includePicture&&i.closest("picture"))return;t.add(i)}}),[...t]}async waitForImagesToLoad(e="img",t=!1,i=1e4){this.logDebug("Waiting for images to load",{selector:e,includeFailed:t,timeout:i});let r=this.getImages(e),n=await Promise.all(r.map(s=>this.cache.has(s)?(this.logDebug("Image already cached",{img:s}),{element:s,loaded:!0}):s.complete&&s.naturalWidth>0?(this.cache.set(s,!0),this.logDebug("Image already loaded",{img:s}),{element:s,loaded:!0}):new Promise(d=>{let l=()=>{clearTimeout(u),this.cache.set(s,!0),this.logDebug("Image loaded successfully",{img:s}),d({element:s,loaded:!0})},c=()=>{clearTimeout(u),this.logDebug("Image failed to load",{img:s}),d({element:s,loaded:!1})},u=setTimeout(()=>{s.removeEventListener("load",l),s.removeEventListener("error",c),this.logDebug("Image load timeout",{img:s}),d({element:s,loaded:!1})},i);s.addEventListener("load",l,{once:!0}),s.addEventListener("error",c,{once:!0})})));return t?n:n.filter(s=>s.loaded).map(s=>s.element)}getImageData(e="img"){return this.getImages(e).map(t=>{let i=[];if(this.includePicture){let r=t.closest("picture");r&&r.querySelectorAll("source").forEach(n=>{i.push({srcset:n.srcset||"",type:n.type||"",media:n.media||""})})}return{element:t,src:t.src||"",alt:t.alt||"",href:t.closest("a")?.href??null,sources:i}})}clearCache(){this.logDebug("Clearing image cache"),this.cache=new WeakMap}destroy(){this.container=null,this.destroyed=!0}}});var K,g,Z=h(()=>{"use strict";K=class{callbacks=new Set;running=!1;_rafId=null;errorHandler;constructor(e=console.error){this.errorHandler=e}add(e){if(typeof e!="function")throw new TypeError("AnimationLoop.add: Callback must be a function");this.callbacks.has(e)||this.callbacks.add(e),this.start()}remove(e){this.callbacks.delete(e),this.callbacks.size===0&&this.stop()}clear(){this.callbacks.clear(),this.stop()}has(e){return this.callbacks.has(e)}pause(){this.stop()}resume(){this.callbacks.size>0&&this.start()}start(){this.running||this.callbacks.size===0||(this.running=!0,this._rafId=requestAnimationFrame(this._loop))}stop(){this.running=!1,this._rafId!==null&&cancelAnimationFrame(this._rafId),this._rafId=null}_loop=()=>{if(this.running){for(let e of Array.from(this.callbacks))try{e()}catch(t){this.errorHandler(t)}this._rafId=requestAnimationFrame(this._loop)}}},g=new K});var oe={};A(oe,{SlidePlayer:()=>Q,VERSION:()=>Le});var Le,Q,le=h(()=>{"use strict";p();W();J();Z();Le="nextworld-1.2.0",Q=class a{static SWIPE_THRESHOLD=50;static VERTICAL_TOLERANCE=30;static DEFAULT_INTERVAL=5e3;container;interval;includePicture;dotsSelector;autoCreateDots;enableBusEvents;autoplay;debug;slides=[];dots=[];dotsWrapper=null;currentIndex=0;lastTickTime=0;isDestroyed=!1;isPointerDown=!1;pointerStartX=0;pointerStartY=0;pointerEndX=0;pointerEndY=0;pauseReasons=new Set;loader;binder;animateCallback;lastPauseState=!1;ready;initError=null;constructor(e,{interval:t=a.DEFAULT_INTERVAL,includePicture:i=!1,dotsSelector:r=".dots",autoCreateDots:n=!1,startPaused:s=!1,enableBusEvents:d=!0,autoplay:l=!0,debug:c=!1}={}){this.container=this.resolveContainer(e),this.interval=t>0?t:a.DEFAULT_INTERVAL,this.includePicture=i,this.dotsSelector=r,this.autoCreateDots=n,this.enableBusEvents=d,this.autoplay=l,this.debug=c,this.loader=new L(this.container,{includePicture:i}),this.binder=new f(this.debug),s&&this.pauseReasons.add("manual"),this.animateCallback=()=>this.animate(),this.ready=this.init().catch(u=>{this.initError=u,this.log("error","SlidePlayer init failed",u)}).then(()=>{}),this.log("info","SlidePlayer initialized",{container:this.container,interval:t,autoplay:l,debug:c})}log(e,t,i){if(!this.debug&&e==="debug")return;let r={scope:"SlidePlayer",level:e,message:t,data:i,time:Date.now()};o.emit("slideplayer:log",{level:e,message:t,data:i}),o.emit("log",r),this.debug&&console[{debug:"debug",info:"info",warn:"warn",error:"error"}[e]]?.(`[SlidePlayer] [${e.toUpperCase()}]`,t,i)}resolveContainer(e){let t=typeof e=="string"?document.querySelector(e):e;if(!t)throw new Error("SlidePlayer: container element not found.");return t}async init(){if(await this.loader.waitForImagesToLoad(),this.refreshSlides(),!this.slides.length){this.log("warn","No .slide elements found in container.");return}this.setupDots(),this.bindEvents(),this.setActiveSlide(0),this.lastTickTime=performance.now(),!this.isPaused()&&this.autoplay&&g.add(this.animateCallback)}animate(){if(this.isDestroyed||!this.autoplay||this.isPaused()||this.slides.length<2)return;let e=performance.now();e-this.lastTickTime>=this.interval&&(this.next(!1),this.lastTickTime=e)}togglePause(e,t){t?this.pauseReasons.add(e):this.pauseReasons.delete(e),this.emitPauseResumeIfChanged(),this.isPaused()?(g.has(this.animateCallback)&&g.remove(this.animateCallback),this.log("debug",`Paused due to: ${Array.from(this.pauseReasons).join(", ")}`)):(g.has(this.animateCallback)||g.add(this.animateCallback),this.log("debug","Resumed playback"))}emitPauseResumeIfChanged(){let e=this.isPaused();if(e!==this.lastPauseState){this.lastPauseState=e;let t=e?"slideplayer:paused":"slideplayer:resumed";this.emit(t,{reasons:Array.from(this.pauseReasons)})}}play(){this.togglePause("manual",!1)}pause(){this.togglePause("manual",!0)}isPaused(){return this.pauseReasons.size>0}goToSlide(e,t=!0){e<0||e>=this.slides.length||e===this.currentIndex||(this.setActiveSlide(e),t&&this.resetTimer())}next(e=!0){this.slides.length<2||this.goToSlide((this.currentIndex+1)%this.slides.length,e)}prev(e=!0){if(this.slides.length<2)return;let t=(this.currentIndex-1+this.slides.length)%this.slides.length;this.goToSlide(t,e)}refreshSlides(){this.slides=Array.from(this.container.querySelectorAll(".slide"))}setupDots(){this.dotsWrapper=this.container.querySelector(this.dotsSelector),!this.dotsWrapper&&this.autoCreateDots&&(this.dotsWrapper=document.createElement("div"),this.dotsWrapper.className="dots",this.container.appendChild(this.dotsWrapper)),this.dotsWrapper&&(this.dotsWrapper.innerHTML="",this.dots=this.slides.map((e,t)=>{let i=document.createElement("div");return i.className="dot",i.dataset.index=t.toString(),this.binder.bindDOM(i,"click",()=>this.goToSlide(t)),this.dotsWrapper.appendChild(i),i}))}updateDots(e){this.dots.forEach((t,i)=>t.classList.toggle("active",i===e))}setActiveSlide(e){let t=this.currentIndex;this.slides[this.currentIndex]?.classList.remove("active"),this.currentIndex=e,this.slides[this.currentIndex]?.classList.add("active"),this.updateDots(e),t!==e&&this.emit("slideplayer:slideChanged",{index:e},"slideplayer:slide-changed")}resetTimer(){this.lastTickTime=performance.now()}bindEvents(){this.bindPointerEvents(),this.bindKeyboardEvents(),this.bindVisibilityEvents(),this.bindActivityEvents(),this.bindUnloadEvent()}bindPointerEvents(){this.binder.bindDOM(this.container,"pointerdown",e=>{let t=e;this.isPointerDown=!0,this.pointerStartX=t.clientX,this.pointerStartY=t.clientY,this.pointerEndX=t.clientX,this.pointerEndY=t.clientY}),this.binder.bindDOM(this.container,"pointermove",e=>{if(!this.isPointerDown)return;let t=e;this.pointerEndX=t.clientX,this.pointerEndY=t.clientY}),this.binder.bindDOM(window,"pointerup",()=>{this.isPointerDown&&(this.handleSwipe(),this.isPointerDown=!1)}),this.binder.bindDOM(window,"pointercancel",()=>{this.isPointerDown=!1}),this.binder.bindDOM(this.container,"pointerleave",()=>this.isPointerDown=!1),this.binder.bindDOM(this.container,"mouseenter",()=>this.togglePause("hover",!0)),this.binder.bindDOM(this.container,"mouseleave",()=>this.togglePause("hover",!1))}bindKeyboardEvents(){this.binder.bindDOM(document,"keydown",e=>{let t=e;t.key==="ArrowRight"?this.next():t.key==="ArrowLeft"&&this.prev()})}bindVisibilityEvents(){this.binder.bindDOM(document,"visibilitychange",()=>{this.togglePause("hidden",document.visibilityState==="hidden")})}bindActivityEvents(){this.enableBusEvents&&(this.binder.bindBus("user:inactive",()=>this.togglePause("inactivity",!0)),this.binder.bindBus("user:active",()=>this.togglePause("inactivity",!1)))}bindUnloadEvent(){this.binder.bindDOM(window,"beforeunload",()=>this.destroy())}handleSwipe(){let e=this.pointerEndX-this.pointerStartX,t=this.pointerEndY-this.pointerStartY;if(Math.abs(e)>=a.SWIPE_THRESHOLD&&Math.abs(t)<a.VERTICAL_TOLERANCE){let i=e<0?"next":"prev";this.log("debug","Swipe detected",{dx:e,dy:t,direction:i}),e<0?this.next():this.prev()}}emit(e,t,i){this.container.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0})),this.enableBusEvents&&i&&o.emit(i,t)}destroy(){this.isDestroyed||(this.isDestroyed=!0,g.remove(this.animateCallback),this.binder.unbindAll(),this.loader.destroy(),this.slides=[],this.dots=[],this.dotsWrapper=null,this.pauseReasons.clear(),this.log("info","SlidePlayer destroyed"))}get currentSlideIndex(){return this.currentIndex}get slideCount(){return this.slides.length}}});var D,de=h(()=>{"use strict";D=(a,e,t)=>{if(e>t)throw new RangeError("The `min` value cannot be greater than the `max` value.");return Math.max(e,Math.min(a,t))}});var ce,_,he,ue,k,ge=h(()=>{"use strict";de();ce=.85,_=.1,he=2.5,ue=.02,k=class{element;size;x;y;vx;vy;options;constructor(e,t,i={}){this.element=e,this.options={useSubpixel:!0,debug:!1,...i},this.size={width:e.offsetWidth,height:e.offsetHeight},this.x=Math.random()*Math.max(0,t.width-this.size.width),this.y=Math.random()*Math.max(0,t.height-this.size.height),this.vx=(Math.random()-.5)*3,this.vy=(Math.random()-.5)*3,e.style.willChange="transform",e.style.backfaceVisibility="hidden",e.style.perspective="1000px",e.style.opacity="1",this.updatePosition()}logDebug(e,t){this.options.debug&&console.debug(`[FloatingImage] ${e}`,t)}updatePosition(){if(!this.element)return this.logDebug("updatePosition called on destroyed element"),!1;let e=this.options.useSubpixel?this.x:Math.round(this.x),t=this.options.useSubpixel?this.y:Math.round(this.y);return this.element.style.transform=`translate3d(${e}px, ${t}px, 0)`,this.logDebug("Position updated",{x:e,y:t}),!0}update(e,t,i=!0){return this.element?(this.x+=this.vx*e,this.y+=this.vy*e,this.handleCollisions(t),this.applyVelocityJitter(),i?this.updatePosition():!0):(this.logDebug("update called on destroyed element"),!1)}handleCollisions(e){if(this.x<=0||this.x+this.size.width>=e.width){this.vx=-this.vx*ce;let t=this.vx>=0?1:-1;this.vx=Math.abs(this.vx)<_?t*_:this.vx,this.x=D(this.x,0,Math.max(0,e.width-this.size.width)),this.logDebug("Horizontal collision handled",{x:this.x,vx:this.vx})}if(this.y<=0||this.y+this.size.height>=e.height){this.vy=-this.vy*ce;let t=this.vy>=0?1:-1;this.vy=Math.abs(this.vy)<_?t*_:this.vy,this.y=D(this.y,0,Math.max(0,e.height-this.size.height)),this.logDebug("Vertical collision handled",{y:this.y,vy:this.vy})}}applyVelocityJitter(){this.vx+=(Math.random()-.5)*ue,this.vy+=(Math.random()-.5)*ue;let e=this.vx**2+this.vy**2;if(e>he**2){let t=he/Math.sqrt(e);this.vx*=t,this.vy*=t,this.logDebug("Velocity clamped",{vx:this.vx,vy:this.vy})}}resetPosition(e){this.x=Math.random()*Math.max(0,e.width-this.size.width),this.y=Math.random()*Math.max(0,e.height-this.size.height),this.updatePosition()}updateSize(){this.element&&(this.size.width=this.element.offsetWidth,this.size.height=this.element.offsetHeight)}clampPosition(e){this.x=D(this.x,0,Math.max(0,e.width-this.size.width)),this.y=D(this.y,0,Math.max(0,e.height-this.size.height))}destroy(){this.element&&(this.element.style.willChange="auto",this.element.style.backfaceVisibility="",this.element.style.perspective="",this.element=null)}}});var $,pe=h(()=>{"use strict";$=class{fps=60;lastTime=performance.now();frameSkipThreshold=30;shouldSkipFrame=!1;frameCount=0;cachedPerformanceLevel="high";lastLevelUpdate=0;levelUpdateInterval=1e3;cachedSettings=null;lastLoggedFPS=60;fpsLogThreshold=5;update(){let e=performance.now(),t=e-this.lastTime;if(t<1)return this.shouldSkipFrame;let i=1e3/t;return this.fps=this.fps*.9+i*.1,this.frameCount++,this.shouldSkipFrame=this.fps<this.frameSkipThreshold,Math.abs(this.fps-this.lastLoggedFPS)>=this.fpsLogThreshold&&(this.lastLoggedFPS=this.fps),this.lastTime=e,this.shouldSkipFrame}getFrameCount(){return this.frameCount}getCurrentFPS(){return Math.round(this.fps*10)/10}getPerformanceLevel(){let e=performance.now();return e-this.lastLevelUpdate>this.levelUpdateInterval&&(this.cachedPerformanceLevel=this.fps>=50?"high":this.fps>=30?"medium":"low",this.lastLevelUpdate=e,this.cachedSettings=null),this.cachedPerformanceLevel}getRecommendedSettings(){if(this.cachedSettings)return this.cachedSettings;let e=this.getPerformanceLevel(),t={high:{maxImages:50,speedMultiplier:1,useSubpixel:!0},medium:{maxImages:25,speedMultiplier:.8,useSubpixel:!1},low:{maxImages:10,speedMultiplier:.5,useSubpixel:!1}};return this.cachedSettings=t[e],this.cachedSettings}reset(){this.fps=60,this.lastTime=performance.now(),this.shouldSkipFrame=!1,this.frameCount=0,this.cachedPerformanceLevel="high",this.lastLevelUpdate=0,this.cachedSettings=null,this.lastLoggedFPS=60}}});var ee,H,me=h(()=>{"use strict";S();ee=class{windowCallbacks=new Map;elementObservers=new Map;logDebug(e,t){console.debug(`[ResizeManager] ${e}`,t)}wrapCallback(e,t){if(t?.debounceMs!=null)return b(e,t.debounceMs);if(t?.throttleMs!=null)return O(e,t.throttleMs);{let i=e;return i.cancel=()=>{},i}}onWindow(e,t={debounceMs:200}){let i=b(e,t.debounceMs),r=()=>i();return this.windowCallbacks.set(e,r),window.addEventListener("resize",r),()=>{window.removeEventListener("resize",r),i.cancel?.(),this.windowCallbacks.delete(e)}}onElement(e,t,i){this.logDebug("Registering element resize callback",{el:e,cb:t,options:i});let r=this.elementObservers.get(e);if(!r){let s=new Set,d=new ResizeObserver(l=>{try{let c=l[0];s.forEach(u=>u(c))}catch(c){this.logDebug("ResizeObserver callback error",{error:c})}});r={observer:d,callbacks:s},this.elementObservers.set(e,r),d.observe(e)}let n=this.wrapCallback(t,i);return r.callbacks.add(n),()=>{this.logDebug("Removing element resize callback",{el:e,cb:t}),r.callbacks.delete(n),n.cancel?.(),r.callbacks.size===0&&(r.observer.disconnect(),this.elementObservers.delete(e))}}getElement(e){try{let t=e.getBoundingClientRect();return{width:t.width,height:t.height}}catch{throw new Error("ResizeManager: Failed to get element size.")}}destroy(){this.logDebug("Destroying ResizeManager");for(let[e,t]of this.windowCallbacks.entries())window.removeEventListener("resize",t);this.windowCallbacks.clear();for(let e of this.elementObservers.values()){e.observer.disconnect();for(let t of e.callbacks)t.cancel?.()}this.elementObservers.clear(),this.logDebug("ResizeManager destroyed")}},H=new ee});var C,fe=h(()=>{"use strict";ge();pe();me();J();Z();p();S();C=class{container;performanceMonitor;images=[];speedMultiplier=1;isInViewport=!0;_destroyed=!1;animateCallback;maxImages;intersectionObserver;unsubscribeWindow;unsubscribeElement;imageLoader;containerWidth;containerHeight;debug;constructor(e,t={}){this.container=e,this.debug=t.debug??!1,this.performanceMonitor=new $;let i=this.performanceMonitor.getRecommendedSettings();this.maxImages=t.maxImages??i.maxImages,this.intersectionObserver=new IntersectionObserver(r=>{let n=r[0];n&&(this.isInViewport=!!n.isIntersecting)},{threshold:0}),this.intersectionObserver.observe(this.container),this.setupResizeHandling(),this.imageLoader=new L(this.container),this.updateContainerDimensions(),this.animateCallback=()=>this.animate(),g.has(this.animateCallback)||g.add(this.animateCallback),this.initializeImages(),this.log("info","FloatingImagesManager initialized",{container:this.container,maxImages:this.maxImages})}log(e,t,i){if(!this.debug&&e==="debug")return;let r={scope:"FloatingImagesManager",level:e,message:t,data:i,time:Date.now()};if(o.emit("floatingImages:log",{level:e,message:t,data:i}),o.emit("log",r),this.debug){let s={debug:"debug",info:"info",warn:"warn",error:"error"}[e]??"log";console[s](`[FloatingImagesManager] [${e.toUpperCase()}]`,t,i)}}setupResizeHandling(){this.unsubscribeWindow=H.onWindow(()=>this.handleResize()),this.unsubscribeElement=H.onElement(this.container,()=>this.handleResize())}updateContainerDimensions(){if(!this.container.isConnected){this.containerWidth=0,this.containerHeight=0,this.log("warn","Container is not in the DOM, dimensions set to 0");return}let e=H.getElement(this.container);this.containerWidth=e.width,this.containerHeight=e.height}async initializeImages(){try{let e=await this.imageLoader.waitForImagesToLoad(".floating-image"),t={width:this.containerWidth,height:this.containerHeight};e.slice(0,this.maxImages).forEach(i=>{this._destroyed||this.addExistingImage(i,t)}),this.log("info","Images initialized",{count:this.images.length})}catch(e){this.log("error","Failed to initialize images",e)}}addExistingImage(e,t){if(this.images.length>=this.maxImages)return;let i=new k(e,t,{debug:this.debug});this.images.push(i)}handleResize=b(()=>{try{if(this._destroyed)return;if(!this.container.isConnected){this.log("warn","Resize event ignored, container not in DOM");return}this.updateContainerDimensions();let e={width:this.containerWidth,height:this.containerHeight};this.images.forEach(t=>{t.updateSize(),t.clampPosition(e),t.updatePosition()}),this.log("debug","Container resized",e)}catch(e){this.log("error","Error during handleResize",e)}},200);animate(){if(this._destroyed||!this.isInViewport||this.speedMultiplier===0||this.performanceMonitor.update())return;let t=this.speedMultiplier,i={width:this.containerWidth,height:this.containerHeight};this.images=this.images.filter(r=>r.update(t,i))}resetAllImagePositions(){let e={width:this.containerWidth,height:this.containerHeight};this.images.forEach(t=>t.resetPosition(e)),this.log("debug","All image positions reset",e)}reinitializeImages(){try{if(this._destroyed)return;if(!this.container.isConnected){this.log("warn","reinitializeImages: container not in DOM, skipping");return}this.images.forEach(i=>i.destroy()),this.images.length=0;let e={width:this.containerWidth,height:this.containerHeight};Array.from(this.container.querySelectorAll(".floating-image")).slice(0,this.maxImages).forEach(i=>{let r=new k(i,e,{debug:this.debug});this.images.push(r)}),this.log("info","Images reinitialized",{count:this.images.length})}catch(e){this.log("error","Error during reinitializeImages",e)}}destroy(){this._destroyed||(this._destroyed=!0,g.has(this.animateCallback)&&g.remove(this.animateCallback),this.unsubscribeWindow?.(),this.unsubscribeElement?.(),this.unsubscribeWindow=void 0,this.unsubscribeElement=void 0,this.intersectionObserver.disconnect(),this.images.forEach(e=>e.destroy()),this.images.length=0,this.imageLoader.destroy(),this.containerWidth=0,this.containerHeight=0,this.log("info","FloatingImagesManager destroyed"))}}});var ve={};A(ve,{ScreensaverController:()=>te,VERSION:()=>Pe});var Pe,te,be=h(()=>{"use strict";p();W();q();Y();fe();Pe="nextworld-1.2.0",te=class{partialUrl;targetSelector;inactivityDelay;debug;onError;screensaverManager=null;watcher=null;_destroyed=!1;eventBinder;_partialLoaded=!1;partialFetcher;_loadPromise;_hideTimeout=null;_bound=!1;_onInactivity;_onActivity;constructor(e){this.partialUrl=e.partialUrl,this.targetSelector=e.targetSelector,this.inactivityDelay=e.inactivityDelay??12e3,this.debug=!!e.debug,this.watcher=e.watcher??null,this.partialFetcher=e.partialFetcher??x,this.onError=e.onError,this.eventBinder=new f(this.debug),this._onInactivity=this.showScreensaver.bind(this),this._onActivity=this.hideScreensaver.bind(this),this.log("info","ScreensaverController initialized",{partialUrl:this.partialUrl,targetSelector:this.targetSelector,inactivityDelay:this.inactivityDelay})}log(e,t,i){if(!this.debug&&e==="debug")return;let r={scope:"ScreensaverController",level:e,message:t,data:i,time:Date.now()};if(o.emit("screensaver:log",{level:e,message:t,data:i}),o.emit("log",r),this.debug){let s={debug:"debug",info:"info",warn:"warn",error:"error"}[e]??"log";console[s](`[ScreensaverController] [${e.toUpperCase()}]`,t,i)}}async init(){if(!this._destroyed&&!this._bound)try{this.watcher||(this.watcher=y.getInstance({inactivityDelay:this.inactivityDelay})),this.eventBinder.bindBus("user:inactive",this._onInactivity),this.eventBinder.bindBus("user:active",this._onActivity),this._bound=!0,this.log("info","Bound user inactivity/active events")}catch(e){this.handleError("Failed to initialize inactivity watcher",e)}}async showScreensaver(){if(!this._destroyed)try{this._partialLoaded||(this._loadPromise||(this._loadPromise=this.partialFetcher.load(this.partialUrl,this.targetSelector).then(()=>{this._partialLoaded=!0}).finally(()=>{this._loadPromise=void 0})),await this._loadPromise);let e=document.querySelector(this.targetSelector);if(!e){this.handleError(`Target selector "${this.targetSelector}" not found`,null);return}e.style.opacity="0",e.style.display="",e.offsetWidth,e.style.transition="opacity 0.5s ease",e.style.opacity="1",this.screensaverManager?(this.screensaverManager.destroy(),this.screensaverManager=new C(e,{debug:this.debug})):this.screensaverManager=new C(e,{debug:this.debug}),this.log("info","Screensaver displayed")}catch(e){this.handleError("Failed to load or show screensaver",e)}}hideScreensaver(){if(!this._destroyed)try{let e=document.querySelector(this.targetSelector);e&&(e.style.transition="opacity 0.5s ease",e.style.opacity="0",this._hideTimeout&&clearTimeout(this._hideTimeout),this._hideTimeout=window.setTimeout(()=>{e.style.display="none",this._hideTimeout=null},500)),this.log("debug","Screensaver hidden")}catch(e){this.handleError("Failed to hide screensaver",e)}}destroy(){if(!this._destroyed){this._destroyed=!0,this.hideScreensaver();try{this.screensaverManager?.destroy()}catch(e){this.log("warn","screensaverManager.destroy() failed",e)}this.eventBinder.unbindAll(),this._partialLoaded=!1,this._hideTimeout&&(clearTimeout(this._hideTimeout),this._hideTimeout=null),this._loadPromise=void 0,this._bound=!1,this.log("info","ScreensaverController destroyed")}}handleError(e,t){o.emit("screensaver:error",{message:e,error:t}),this.onError?.(e,t),this.log("error",e,t)}}});var T=class{static#e=null;static ready(){return this.#e||(this.#e=document.readyState!=="loading"?Promise.resolve():new Promise(e=>{document.addEventListener("DOMContentLoaded",()=>e(),{once:!0})})),this.#e}static waitForElement(e,t={}){let{timeout:i=5e3,root:r=document,signal:n}=t;if(i<=0)return Promise.reject(new TypeError("Timeout must be greater than 0"));let s=Array.isArray(e)?e:[e],d=new Map;return new Promise((l,c)=>{let u,m=()=>{for(let I of s)if(!d.has(I)){let F=r.querySelector(I);F&&d.set(I,F)}d.size===s.length&&(v(),l(s.length===1?d.get(s[0]):Array.from(d.values())))},P=new MutationObserver(m),v=()=>{P.disconnect(),u!==void 0&&clearTimeout(u),n?.removeEventListener("abort",N)},N=()=>{v(),c(new DOMException("waitForElement aborted","AbortError"))};if(n?.aborted)return N();n?.addEventListener("abort",N,{once:!0}),P.observe(r,{childList:!0,subtree:!0}),m(),u=window.setTimeout(()=>{v();let I=s.filter(F=>!d.has(F));c(new DOMException(`Element(s) "${I.join(", ")}" not found within ${i}ms in root: ${r.nodeName}`,"TimeoutError"))},i)})}};q();p();W();j();Y();B();function X(a="id",e=9,t=!1){if(!Number.isInteger(e)||e<=0)throw new Error("Length must be a positive integer.");let i=t?Array.from(crypto.getRandomValues(new Uint8Array(e))).map(r=>(r%36).toString(36)).join(""):Math.random().toString(36).slice(2,2+e);return`${a}-${i}`}G();var ie=class{config;constructor(e={}){this.config={hostname:window.location.hostname,production:window.location.hostname!=="localhost"&&!window.location.hostname.includes("127.0.0.1"),features:e.features??{},...e}}get(e){return e.split(".").reduce((t,i)=>{if(t?.[i]===void 0){console.log(`[spaceface] Config key "${e}" is undefined`);return}return t[i]},this.config)}},U=class a{static EVENT_LOG="log";static EVENT_TELEMETRY="telemetry";appConfig;debug;pageType;startTime;featureModules;featureCache=new Map;inactivityWatcher=null;screensaverController=null;slideshows=[];swManager;_partialUnsub;_partialObserver;pjaxFeatures=new Map;constructor(e={}){this.appConfig=new ie(e),this.debug=!!this.appConfig.config.debug,this.pageType=this.resolvePageType(),this.startTime=performance.now(),this.featureModules={partialLoader:()=>Promise.resolve().then(()=>(B(),se)),slideplayer:()=>Promise.resolve().then(()=>(le(),oe)),screensaver:()=>Promise.resolve().then(()=>(be(),ve)),serviceWorker:()=>Promise.resolve().then(()=>(G(),ae))},this.appConfig.config.features||this.log("warn","No features specified in config")}log(e,...t){if(!this.debug&&e==="debug")return;let[i,...r]=t,n=typeof i=="string"?i:"",s=typeof i=="string"?r.length?r:void 0:t.length?t:void 0,d={level:e,args:t,scope:"Spaceface",message:n,data:s,time:Date.now()};o.emit(a.EVENT_LOG,d),this.debug&&console[e]?.(`[spaceface] [${e.toUpperCase()}]`,...t)}resolvePageType(){let e=document.body;if(e.dataset.page)return e.dataset.page;let t=window.location.pathname;return t==="/"?"home":t==="/app"?"app":"default"}async loadFeatureModule(e){if(this.featureCache.has(e))return this.featureCache.get(e);try{let t=await this.featureModules[e]?.();if(!t)throw new Error(`Module "${e}" could not be loaded.`);return this.featureCache.set(e,t),t}catch(t){return this.log("error",`Failed to load module "${e}"`,t),this.featureCache.set(e,null),null}}async initBase(){this.log("info",`App initialization started (Page: ${this.pageType})`),document.documentElement.classList.add("js-enabled",`page-${this.pageType}`),await T.ready(),this.log("info","DOM ready")}finishInit(){let e=(performance.now()-this.startTime).toFixed(2);this.log("info",`App initialized in ${e}ms`),o.emit(a.EVENT_TELEMETRY,{type:"init:duration",value:e,page:this.pageType})}async initInactivityWatcher(){let e=performance.now(),t=this.appConfig.config.features?.screensaver;if(!t||this.inactivityWatcher){this.emitFeatureTelemetry("inactivityWatcher",e,"skipped");return}try{this.inactivityWatcher=y.getInstance({inactivityDelay:t.delay??3e3}),this.log("debug",`InactivityWatcher initialized with delay=${t.delay??3e3}ms`),this.emitFeatureTelemetry("inactivityWatcher",e,"success")}catch(i){throw this.emitFeatureTelemetry("inactivityWatcher",e,"error",i),i}}async initSlidePlayer(){let e=performance.now(),t=this.appConfig.config.features?.slideplayer;if(!t){this.emitFeatureTelemetry("slideplayer",e,"skipped");return}try{let r=(await this.loadFeatureModule("slideplayer"))?.SlidePlayer;if(!r){this.emitFeatureTelemetry("slideplayer",e,"skipped");return}this.slideshows=Array.from(document.querySelectorAll(".slideshow-container")).map(n=>{let s=new r(n,{interval:t.interval??5e3,includePicture:t.includePicture??!1});return s.ready?.then?.(()=>{}),s}),this.log("info",`${this.slideshows.length} SlidePlayer instance(s) loaded`),this.emitFeatureTelemetry("slideplayer",e,"success")}catch(i){throw this.emitFeatureTelemetry("slideplayer",e,"error",i),i}}async initScreensaver(){let e=performance.now(),t=this.appConfig.config.features?.screensaver;if(!t?.partialUrl){this.log("error","Screensaver configuration is missing or incomplete"),this.emitFeatureTelemetry("screensaver",e,"skipped");return}try{let r=(await this.loadFeatureModule("screensaver"))?.ScreensaverController;if(!r)throw new Error("ScreensaverController module is unavailable.");let n=X("screensaver",9),s=Object.assign(document.createElement("div"),{id:n,style:"position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 999; display: none;"});document.body.appendChild(s),this.screensaverController=new r({partialUrl:t.partialUrl,targetSelector:`#${n}`,...t.delay!==void 0&&{inactivityDelay:t.delay}}),await this.screensaverController?.init?.(),o.emit("screensaver:initialized",n),this.log("info","Screensaver initialized:",n),this.emitFeatureTelemetry("screensaver",e,"success")}catch(i){this.log("error","Failed to initialize screensaver:",i),this.emitFeatureTelemetry("screensaver",e,"error",i)}}async initServiceWorker(){let e=performance.now();if(!this.appConfig.config.features?.serviceWorker){this.emitFeatureTelemetry("serviceWorker",e,"skipped");return}try{let i=(await this.loadFeatureModule("serviceWorker"))?.default;if(!i){this.emitFeatureTelemetry("serviceWorker",e,"skipped");return}this.swManager=new i("/sw.js",{},{strategy:{images:"cache-first",others:"network-first"}}),this.swManager&&(await this.swManager.register(),this.swManager.configure(),this.log("info","Service Worker registered and configured"),this.emitFeatureTelemetry("serviceWorker",e,"success"))}catch(t){throw this.emitFeatureTelemetry("serviceWorker",e,"error",t),t}}async initPartialLoader(){let e=performance.now(),t=this.appConfig.config.features?.partialLoader;if(!t?.enabled)return this.emitFeatureTelemetry("partialLoader",e,"skipped"),null;try{let r=(await this.loadFeatureModule("partialLoader"))?.PartialLoader;if(!r)return this.emitFeatureTelemetry("partialLoader",e,"skipped"),null;let n=new r({debug:t.debug??this.debug,baseUrl:t.baseUrl??"/",cacheEnabled:t.cacheEnabled??!0});await n.loadContainer(document);let s=n.watch?.(document);return typeof s=="function"?this._partialUnsub=s:this._partialObserver=s,this.log("info","PartialLoader initialized"),this.emitFeatureTelemetry("partialLoader",e,"success"),n}catch(i){throw this.emitFeatureTelemetry("partialLoader",e,"error",i),i}}async initDomFeatures(){await this.initSlidePlayer()}async initOnceFeatures(){let e=[this.initInactivityWatcher(),this.initScreensaver(),this.initServiceWorker()];await Promise.allSettled(e),this.log("info",`Page features initialized for: ${this.pageType}`)}registerPjaxFeature(e,t,i){this.pjaxFeatures.has(e)||this.pjaxFeatures.set(e,{init:t,when:i})}async handlePjaxComplete(){this.pageType=this.resolvePageType(),document.documentElement.classList.add(`page-${this.pageType}`),this.slideshows.forEach(e=>e.destroy?.()),this.slideshows=[];for(let{init:e,when:t}of this.pjaxFeatures.values())t&&!t(this.pageType)||await e()}destroy(){this._partialUnsub?.(),this._partialObserver?.disconnect?.(),this.slideshows.forEach(e=>e.destroy?.()),this.inactivityWatcher?.destroy?.(),this.screensaverController?.destroy?.(),this.featureCache.clear(),document.querySelector('[id^="screensaver"]')?.remove(),this.log("info","Spaceface destroyed, all resources released.")}emitFeatureTelemetry(e,t,i,r){let n=(performance.now()-t).toFixed(2);o.emit(a.EVENT_TELEMETRY,{type:"feature:init",feature:e,status:i,duration:n,page:this.pageType,error:r})}};var w=new U({features:{partialLoader:{enabled:!0,debug:!0,baseUrl:"/",cacheEnabled:!0},slideplayer:{interval:5e3,includePicture:!1},screensaver:{delay:4500,partialUrl:"content/feature/screensaver/index.html"},serviceWorker:!0}});w.initBase().then(async()=>{await w.initPartialLoader(),await w.initDomFeatures(),await w.initOnceFeatures(),w.finishInit()});var Ie=["localhost","127.0.0.1"].some(a=>window.location.hostname.includes(a));Ie&&o.onAny((a,e)=>{if(a==="log:debug"||a==="log"&&e?.level==="debug")return;let{level:t="log",args:i,...r}=e??{};if(!e)return console.log(`[spaceface onAny] Event: ${a} \u2013 no payload!`);if(typeof e=="string")return console.log(`[spaceface onAny] Event: ${a} [LOG]`,e);let n=i??r??"(no details)",d={debug:"debug",info:"info",warn:"warn",error:"error",log:"log"}[t]??"log";console[d](`[SPCFC *] Event: ${a} [${String(t).toUpperCase()}] \u2013`,n)});window.addEventListener("beforeunload",()=>{w.destroy(),w.log("info","App destroyed on beforeunload")});
//# sourceMappingURL=bundle.min.js.map
